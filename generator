#!/bin/bash

# Combined generator script for Atlan Python SDK
# This script runs both create_typedefs_file.py and class_generator.py
# It intelligently skips creating typedefs if they already exist and are current

# Usage: ./generator [typedefs_file_path]
# If typedefs_file_path is not provided, defaults to /tmp/typedefs.json

echo "ğŸš€ Starting Atlan Python SDK code generation..."

# Check if ATLAN_BASE_URL and ATLAN_API_KEY are set
if [ -z "$ATLAN_BASE_URL" ] || [ -z "$ATLAN_API_KEY" ]; then
    echo "âŒ Error: ATLAN_BASE_URL and ATLAN_API_KEY environment variables must be set."
    echo "Please set these variables before running the generator:"
    echo "  export ATLAN_BASE_URL='https://your-atlan-instance.com'"
    echo "  export ATLAN_API_KEY='your-api-key'"
#    exit 1
fi

# Get the typedefs file path from command line argument or use default
if [ -n "$1" ]; then
    TYPE_DEF_FILE="$1"
    echo "ğŸ“ Using custom typedefs file: $TYPE_DEF_FILE"
else
    TMPDIR=${TMPDIR:-/tmp}
    TYPE_DEF_FILE="$TMPDIR/typedefs.json"
    echo "ğŸ“ Using default typedefs file: $TYPE_DEF_FILE"
fi

# Check if typedefs file exists and is current (created today)
SHOULD_CREATE_TYPEDEFS=true
if [ -f "$TYPE_DEF_FILE" ]; then
    # Check if file was created today
    if [ "$(date -r "$TYPE_DEF_FILE" +%Y-%m-%d)" = "$(date +%Y-%m-%d)" ]; then
        echo "âœ… Typedefs file already exists and is current: $TYPE_DEF_FILE"
        SHOULD_CREATE_TYPEDEFS=false
    else
        echo "â° Typedefs file exists but is not current, will recreate it"
    fi
else
    echo "ğŸ“„ Typedefs file does not exist, will create it"
fi

# Step 1: Create typedefs file if needed
if [ "$SHOULD_CREATE_TYPEDEFS" = true ]; then
    echo "ğŸ”„ Running create_typedefs_file.py..."
    if uv run python pyatlan/generator/create_typedefs_file.py --typedefs-file "$TYPE_DEF_FILE"; then
        echo "âœ… Typedefs file created successfully"
    else
        echo "âŒ Failed to create typedefs file"
        exit 1
    fi
else
    echo "â­ï¸  Skipping typedefs creation (file is current)"
fi

# Step 2: Run class generator
echo "ğŸ”„ Running class_generator.py..."
if uv run python pyatlan/generator/class_generator.py --typedefs-file "$TYPE_DEF_FILE"; then
    echo "âœ… Class generation completed successfully"
else
    echo "âŒ Class generation failed"
    exit 1
fi

# Step 3: Format the generated code
echo "ğŸ¨ Formatting generated code..."
if uv run ./formatter; then
    echo "âœ… Code formatting completed"
else
    echo "âš ï¸  Code formatting had issues, but generation completed"
fi

echo "ğŸ‰ SDK code generation completed successfully!"
echo "ğŸ“ Generated files are in: pyatlan/model/assets/"
