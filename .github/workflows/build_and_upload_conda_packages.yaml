
name: Build and upload conda packages

on:
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  conda_deployment_with_new_tag:
    name: Conda deployment of package with Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Conda environment creation and activation
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: ${{ matrix.python-version }}
          environment-file: .conda-envs/build-env.yaml    # Path to the build conda environment
          auto-update-conda: false
          auto-activate-base: false
          show-channel-urls: true
      - name: Build conda package
        run: |
          conda build .conda-envs --python ${{ matrix.python-version }} --output-folder /tmp/conda-builds
      
      - name: Convert to all platforms
        run: |
          # Find the built package
          PACKAGE_PATH=$(find /tmp/conda-builds -name "*.tar.bz2" | head -1)
          if [ -z "$PACKAGE_PATH" ]; then
            echo "No package found to convert"
            exit 1
          fi
          conda convert -p all "$PACKAGE_PATH" -o /tmp/conda-builds
      
      - name: Upload to Anaconda
        run: |
          # Upload all platform packages
          for pkg in /tmp/conda-builds/*/*.tar.bz2; do
            if [ -f "$pkg" ]; then
              anaconda upload --user atlanhq --label main "$pkg"
            fi
          done
        env:
          ANACONDA_API_TOKEN: ${{ secrets.ANACONDA_API_TOKEN }}
