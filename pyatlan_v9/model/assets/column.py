# Auto-generated by PythonMsgspecRenderer.pkl - DO NOT EDIT
# SPDX-License-Identifier: Apache-2.0
# Copyright 2024 Atlan Pte. Ltd.

"""
Column asset model with flattened inheritance.

This module provides:
- Column: Flat asset class (easy to use)
- ColumnAttributes: Nested attributes struct (extends AssetAttributes)
- ColumnNested: Nested API format struct
"""

from __future__ import annotations

from typing import Any, Union
from warnings import warn

from msgspec import UNSET, UnsetType

from pyatlan.model.enums import AtlanConnectorType
from pyatlan.utils import validate_required_fields
from pyatlan_v9.model.conversion_utils import (
    categorize_relationships,
    merge_relationships,
)
from pyatlan_v9.model.serde import Serde, get_serde
from pyatlan_v9.model.transform import register_asset
from pyatlan_v9.utils import init_guid

from .asset import Asset, AssetAttributes, AssetNested, AssetRelationshipAttributes
from .snowflake_related import RelatedSnowflakeDynamicTable
from .sql_related import (
    RelatedCalculationView,
    RelatedColumn,
    RelatedMaterialisedView,
    RelatedQuery,
    RelatedTable,
    RelatedTablePartition,
    RelatedView,
)

# =============================================================================
# FLAT ASSET CLASS
# =============================================================================


@register_asset
class Column(Asset):
    """
    Instance of a column in Atlan.
    """

    # Override type_name with Column-specific default
    type_name: Union[str, UnsetType] = "Column"

    data_type: Union[str, None, UnsetType] = UNSET
    """Data type of values in this column."""

    sub_data_type: Union[str, None, UnsetType] = UNSET
    """Sub-data type of this column."""

    sql_compression: Union[str, None, UnsetType] = UNSET
    """Compression type of this column."""

    sql_encoding: Union[str, None, UnsetType] = UNSET
    """Encoding type of this column."""

    raw_data_type_definition: Union[str, None, UnsetType] = UNSET
    """Raw data type definition of this column."""

    order: Union[int, None, UnsetType] = UNSET
    """Order (position) in which this column appears in the table (starting at 1)."""

    nested_column_order: Union[str, None, UnsetType] = UNSET
    """Order (position) in which this column appears in the nested Column (nest level starts at 1)."""

    nested_column_count: Union[int, None, UnsetType] = UNSET
    """Number of columns nested within this (STRUCT or NESTED) column."""

    column_hierarchy: Union[list[dict[str, str]], None, UnsetType] = UNSET
    """List of top-level upstream nested columns."""

    is_partition: Union[bool, None, UnsetType] = UNSET
    """Whether this column is a partition column (true) or not (false)."""

    partition_order: Union[int, None, UnsetType] = UNSET
    """Order (position) of this partition column in the table."""

    is_clustered: Union[bool, None, UnsetType] = UNSET
    """Whether this column is a clustered column (true) or not (false)."""

    is_primary: Union[bool, None, UnsetType] = UNSET
    """When true, this column is the primary key for the table."""

    is_foreign: Union[bool, None, UnsetType] = UNSET
    """When true, this column is a foreign key to another table. NOTE: this must be true when using the foreignKeyTo relationship to specify columns that refer to this column as a foreign key."""

    is_indexed: Union[bool, None, UnsetType] = UNSET
    """When true, this column is indexed in the database."""

    is_sort: Union[bool, None, UnsetType] = UNSET
    """Whether this column is a sort column (true) or not (false)."""

    is_dist: Union[bool, None, UnsetType] = UNSET
    """Whether this column is a distribution column (true) or not (false)."""

    is_pinned: Union[bool, None, UnsetType] = UNSET
    """Whether this column is pinned (true) or not (false)."""

    pinned_by: Union[str, None, UnsetType] = UNSET
    """User who pinned this column."""

    pinned_at: Union[int, None, UnsetType] = UNSET
    """Time (epoch) at which this column was pinned, in milliseconds."""

    precision: Union[int, None, UnsetType] = UNSET
    """Total number of digits allowed, when the dataType is numeric."""

    default_value: Union[str, None, UnsetType] = UNSET
    """Default value for this column."""

    is_nullable: Union[bool, None, UnsetType] = UNSET
    """When true, the values in this column can be null."""

    numeric_scale: Union[float, None, UnsetType] = UNSET
    """Number of digits allowed to the right of the decimal point."""

    max_length: Union[int, None, UnsetType] = UNSET
    """Maximum length of a value in this column."""

    validations: Union[dict[str, str], None, UnsetType] = UNSET
    """Validations for this column."""

    parent_column_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the column this column is nested within, for STRUCT and NESTED columns."""

    parent_column_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the column this column is nested within, for STRUCT and NESTED columns."""

    sql_distinct_values_count: Union[int, None, UnsetType] = UNSET
    """Number of rows that contain distinct values."""

    sql_distinct_values_count_long: Union[int, None, UnsetType] = UNSET
    """Number of rows that contain distinct values."""

    sql_histogram: Union[dict[str, Any], None, UnsetType] = UNSET
    """List of values in a histogram that represents the contents of this column."""

    sql_max: Union[float, None, UnsetType] = UNSET
    """Greatest value in a numeric column."""

    sql_min: Union[float, None, UnsetType] = UNSET
    """Least value in a numeric column."""

    sql_mean: Union[float, None, UnsetType] = UNSET
    """Arithmetic mean of the values in a numeric column."""

    sql_sum: Union[float, None, UnsetType] = UNSET
    """Calculated sum of the values in a numeric column."""

    sql_median: Union[float, None, UnsetType] = UNSET
    """Calculated median of the values in a numeric column."""

    sql_standard_deviation: Union[float, None, UnsetType] = UNSET
    """Calculated standard deviation of the values in a numeric column."""

    sql_unique_values_count: Union[int, None, UnsetType] = UNSET
    """Number of rows in which a value in this column appears only once."""

    sql_unique_values_count_long: Union[int, None, UnsetType] = UNSET
    """Number of rows in which a value in this column appears only once."""

    sql_average: Union[float, None, UnsetType] = UNSET
    """Average value in this column."""

    sql_average_length: Union[float, None, UnsetType] = UNSET
    """Average length of values in a string column."""

    sql_duplicate_values_count: Union[int, None, UnsetType] = UNSET
    """Number of rows that contain duplicate values."""

    sql_duplicate_values_count_long: Union[int, None, UnsetType] = UNSET
    """Number of rows that contain duplicate values."""

    sql_maximum_string_length: Union[int, None, UnsetType] = UNSET
    """Length of the longest value in a string column."""

    column_maxs: Union[list[str], None, UnsetType] = UNSET
    """List of the greatest values in a column."""

    sql_minimum_string_length: Union[int, None, UnsetType] = UNSET
    """Length of the shortest value in a string column."""

    column_mins: Union[list[str], None, UnsetType] = UNSET
    """List of the least values in a column."""

    sql_missing_values_count: Union[int, None, UnsetType] = UNSET
    """Number of rows in a column that do not contain content."""

    sql_missing_values_count_long: Union[int, None, UnsetType] = UNSET
    """Number of rows in a column that do not contain content."""

    sql_missing_values_percentage: Union[float, None, UnsetType] = UNSET
    """Percentage of rows in a column that do not contain content."""

    sql_uniqueness_percentage: Union[float, None, UnsetType] = UNSET
    """Ratio indicating how unique data in this column is: 0 indicates that all values are the same, 100 indicates that all values in this column are unique."""

    sql_variance: Union[float, None, UnsetType] = UNSET
    """Calculated variance of the values in a numeric column."""

    column_top_values: Union[list[dict[str, Any]], None, UnsetType] = UNSET
    """List of top values in this column."""

    sql_max_value: Union[float, None, UnsetType] = UNSET
    """Greatest value in a numeric column."""

    sql_min_value: Union[float, None, UnsetType] = UNSET
    """Least value in a numeric column."""

    sql_mean_value: Union[float, None, UnsetType] = UNSET
    """Arithmetic mean of the values in a numeric column."""

    sql_sum_value: Union[float, None, UnsetType] = UNSET
    """Calculated sum of the values in a numeric column."""

    sql_median_value: Union[float, None, UnsetType] = UNSET
    """Calculated median of the values in a numeric column."""

    sql_standard_deviation_value: Union[float, None, UnsetType] = UNSET
    """Calculated standard deviation of the values in a numeric column."""

    sql_average_value: Union[float, None, UnsetType] = UNSET
    """Average value in this column."""

    sql_variance_value: Union[float, None, UnsetType] = UNSET
    """Calculated variance of the values in a numeric column."""

    sql_average_length_value: Union[float, None, UnsetType] = UNSET
    """Average length of values in a string column."""

    sql_distribution_histogram: Union[dict[str, Any], None, UnsetType] = UNSET
    """Detailed information representing a histogram of values for a column."""

    sql_depth_level: Union[int, None, UnsetType] = UNSET
    """Level of nesting of this column, used for STRUCT and NESTED columns."""

    nosql_collection_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the cosmos/mongo collection in which this SQL asset (column) exists, or empty if it does not exist within a cosmos/mongo collection."""

    nosql_collection_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the cosmos/mongo collection in which this SQL asset (column) exists, or empty if it does not exist within a cosmos/mongo collection."""

    sql_is_measure: Union[bool, None, UnsetType] = UNSET
    """When true, this column is of type measure/calculated."""

    sql_measure_type: Union[str, None, UnsetType] = UNSET
    """The type of measure/calculated column this is, eg: base, calculated, derived."""

    query_count: Union[int, None, UnsetType] = UNSET
    """Number of times this asset has been queried."""

    query_user_count: Union[int, None, UnsetType] = UNSET
    """Number of unique users who have queried this asset."""

    query_user_map: Union[dict[str, int], None, UnsetType] = UNSET
    """Map of unique users who have queried this asset to the number of times they have queried it."""

    query_count_updated_at: Union[int, None, UnsetType] = UNSET
    """Time (epoch) at which the query count was last updated, in milliseconds."""

    database_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the database in which this SQL asset exists, or empty if it does not exist within a database."""

    database_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the database in which this SQL asset exists, or empty if it does not exist within a database."""

    schema_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the schema in which this SQL asset exists, or empty if it does not exist within a schema."""

    schema_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the schema in which this SQL asset exists, or empty if it does not exist within a schema."""

    table_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the table in which this SQL asset exists, or empty if it does not exist within a table."""

    table_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the table in which this SQL asset exists, or empty if it does not exist within a table."""

    view_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the view in which this SQL asset exists, or empty if it does not exist within a view."""

    view_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the view in which this SQL asset exists, or empty if it does not exist within a view."""

    calculation_view_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the calculation view in which this SQL asset exists, or empty if it does not exist within a calculation view."""

    calculation_view_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the calculation view in which this SQL asset exists, or empty if it does not exist within a calculation view."""

    is_profiled: Union[bool, None, UnsetType] = UNSET
    """Whether this asset has been profiled (true) or not (false)."""

    last_profiled_at: Union[int, None, UnsetType] = UNSET
    """Time (epoch) at which this asset was last profiled, in milliseconds."""

    sql_ai_model_context_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the context in which the model versions exist, or empty if it does not exist within an AI model context."""

    sql_is_secure: Union[bool, None, UnsetType] = UNSET
    """Whether this asset is secure (true) or not (false)."""

    table: Union[RelatedTable, None, UnsetType] = UNSET
    """Table in which this column exists."""

    nested_columns: Union[list[RelatedColumn], None, UnsetType] = UNSET
    """Nested columns that exist within this column."""

    parent_column: Union[RelatedColumn, None, UnsetType] = UNSET
    """Column in which this sub-column is nested."""

    table_partition: Union[RelatedTablePartition, None, UnsetType] = UNSET
    """Table partition that contains this column."""

    view: Union[RelatedView, None, UnsetType] = UNSET
    """View in which this column exists."""

    calculation_view: Union[RelatedCalculationView, None, UnsetType] = UNSET
    """Calculate view in which this column exists."""

    materialised_view: Union[RelatedMaterialisedView, None, UnsetType] = UNSET
    """Materialized view in which this column exists."""

    snowflake_dynamic_table: Union[RelatedSnowflakeDynamicTable, None, UnsetType] = (
        UNSET
    )
    """SnowflakeDynamicTable in which this column exists."""

    foreign_key_to: Union[list[RelatedColumn], None, UnsetType] = UNSET
    """Columns that use this column as a foreign key."""

    foreign_key_from: Union[RelatedColumn, None, UnsetType] = UNSET
    """Column this foreign key column refers to."""

    queries: Union[list[RelatedQuery], None, UnsetType] = UNSET
    """Queries that access this column."""

    # =========================================================================
    # Creator Methods
    # =========================================================================

    # Valid parent types
    VALID_PARENT_TYPES = [
        "Table",
        "View",
        "MaterialisedView",
        "TablePartition",
        "SnowflakeDynamicTable",
    ]

    @classmethod
    @init_guid
    def creator(
        cls,
        *,
        name: str,
        parent_qualified_name: str,
        parent_type: type,
        order: int,
        parent_name: str | None = None,
        database_name: str | None = None,
        database_qualified_name: str | None = None,
        schema_name: str | None = None,
        schema_qualified_name: str | None = None,
        table_name: str | None = None,
        table_qualified_name: str | None = None,
        connection_qualified_name: str | None = None,
    ) -> "Column":
        """
        Create a new Column asset.

        Args:
            name: Name of the column
            parent_qualified_name: Unique name of the parent (table/view/etc)
            parent_type: Type of parent (Table, View, MaterialisedView, etc)
            order: Order of the column in the parent
            parent_name: Simple name of the parent
            database_name: Simple name of the database
            database_qualified_name: Unique name of the database
            schema_name: Simple name of the schema
            schema_qualified_name: Unique name of the schema
            table_name: (deprecated) Simple name of the table
            table_qualified_name: (deprecated) Unique name of the table
            connection_qualified_name: Unique name of the connection

        Returns:
            Column instance ready to be created

        Raises:
            ValueError: If required parameters are missing or invalid
        """
        if table_name:
            warn(
                ("`table_name` is deprecated, please use `parent_name` instead"),
                DeprecationWarning,
                stacklevel=2,
            )
        if table_qualified_name:
            warn(
                (
                    "`table_qualified_name` is deprecated, please use `parent_qualified_name` instead"
                ),
                DeprecationWarning,
                stacklevel=2,
            )

        validate_required_fields(
            ["name", "parent_qualified_name", "parent_type", "order"],
            [name, parent_qualified_name, parent_type, order],
        )

        # Use AtlanConnectorType.get_connector_name for validation (exact parity with pydantic)
        connection_qn: str | None = None
        if connection_qualified_name:
            connector_name = str(
                AtlanConnectorType.get_connector_name(connection_qualified_name)
            )
        else:
            result = AtlanConnectorType.get_connector_name(
                parent_qualified_name, "parent_qualified_name", 6
            )
            connection_qn = str(result[0])
            connector_name = str(result[1])
        if order < 0:
            raise ValueError("Order must be be a positive integer")

        # Get the type name from the parent_type class
        parent_type_name = getattr(parent_type, "__name__", None)

        # Validate parent type
        valid_types = [
            "Table",
            "View",
            "MaterialisedView",
            "TablePartition",
            "SnowflakeDynamicTable",
            "Column",
        ]
        if parent_type_name not in valid_types:
            raise ValueError(
                "parent_type must be either Table, SnowflakeDynamicTable, View, MaterializeView or TablePartition"
            )

        if parent_type_name == "Column":
            raise ValueError(
                "parent_type must be either Table, SnowflakeDynamicTable, View, MaterializeView or TablePartition"
            )

        # Parse parent_qualified_name to derive fields
        fields = parent_qualified_name.split("/")

        connection_qualified_name = connection_qualified_name or connection_qn
        database_name = database_name or fields[3]
        schema_name = schema_name or fields[4]
        parent_name = parent_name or fields[5]
        database_qualified_name = (
            database_qualified_name or f"{connection_qualified_name}/{database_name}"
        )
        schema_qualified_name = (
            schema_qualified_name or f"{database_qualified_name}/{schema_name}"
        )

        database_qualified_name = (
            database_qualified_name
            or f"{fields[0]}/{fields[1]}/{fields[2]}/{database_name}"
        )
        schema_qualified_name = (
            schema_qualified_name or f"{database_qualified_name}/{schema_name}"
        )

        connection_qualified_name = (
            connection_qualified_name or f"{fields[0]}/{fields[1]}/{fields[2]}"
        )

        qualified_name = f"{parent_qualified_name}/{name}"

        # Build the column
        col = cls(
            name=name,
            qualified_name=qualified_name,
            connector_name=connector_name,
            connection_qualified_name=connection_qualified_name,
            schema_name=schema_name,
            schema_qualified_name=schema_qualified_name,
            database_name=database_name,
            database_qualified_name=database_qualified_name,
            order=order,
        )

        # Set parent-specific fields
        if parent_type_name == "Table":
            col.table_qualified_name = parent_qualified_name
            col.table = RelatedTable(
                qualified_name=parent_qualified_name, type_name="Table"
            )
            col.table_name = parent_name
        elif parent_type_name == "View":
            col.view_qualified_name = parent_qualified_name
            col.view = RelatedView(
                qualified_name=parent_qualified_name, type_name="View"
            )
            col.view_name = parent_name
        elif parent_type_name == "MaterialisedView":
            col.view_qualified_name = parent_qualified_name
            col.materialised_view = RelatedMaterialisedView(
                qualified_name=parent_qualified_name, type_name="MaterialisedView"
            )
            col.view_name = parent_name
        elif parent_type_name == "TablePartition":
            col.table_qualified_name = parent_qualified_name
            col.table_partition = RelatedTablePartition(
                qualified_name=parent_qualified_name, type_name="TablePartition"
            )
            col.table_name = parent_name
        elif parent_type_name == "SnowflakeDynamicTable":
            col.table_qualified_name = parent_qualified_name
            col.snowflake_dynamic_table = RelatedSnowflakeDynamicTable(
                qualified_name=parent_qualified_name,
                type_name="SnowflakeDynamicTable",
            )
            col.table_name = parent_name

        return col

    @classmethod
    def updater(cls, qualified_name: str = "", name: str = "") -> "Column":
        """
        Create a Column instance for modification.

        Args:
            qualified_name: Unique name of the column
            name: Name of the column

        Returns:
            Column instance for modification

        Raises:
            ValueError: If required parameters are missing
        """
        if not qualified_name:
            raise ValueError("qualified_name is required")
        if not name:
            raise ValueError("name is required")

        return cls(qualified_name=qualified_name, name=name)

    # =========================================================================
    # Optimized Serialization Methods (override Asset base class)
    # =========================================================================

    def to_json(self, nested: bool = True, serde: Serde | None = None) -> str:
        """
        Convert to JSON string using optimized nested struct serialization.

        Args:
            nested: If True (default), use nested API format. If False, use flat format.
            serde: Optional Serde instance for encoder reuse. Uses shared singleton if None.

        Returns:
            JSON string representation
        """
        if serde is None:
            serde = get_serde()
        if nested:
            return _column_to_nested_bytes(self, serde).decode("utf-8")
        else:
            return serde.encode(self).decode("utf-8")

    @staticmethod
    def from_json(json_data: Union[str, bytes], serde: Serde | None = None) -> "Column":
        """
        Create from JSON string or bytes using optimized nested struct deserialization.

        Args:
            json_data: JSON string or bytes to deserialize
            serde: Optional Serde instance for decoder reuse. Uses shared singleton if None.

        Returns:
            Column instance
        """
        if isinstance(json_data, str):
            json_data = json_data.encode("utf-8")
        if serde is None:
            serde = get_serde()
        return _column_from_nested_bytes(json_data, serde)


# =============================================================================
# NESTED FORMAT CLASSES
# =============================================================================


class ColumnAttributes(AssetAttributes):
    """Column-specific attributes for nested API format."""

    data_type: Union[str, None, UnsetType] = UNSET
    """Data type of values in this column."""

    sub_data_type: Union[str, None, UnsetType] = UNSET
    """Sub-data type of this column."""

    sql_compression: Union[str, None, UnsetType] = UNSET
    """Compression type of this column."""

    sql_encoding: Union[str, None, UnsetType] = UNSET
    """Encoding type of this column."""

    raw_data_type_definition: Union[str, None, UnsetType] = UNSET
    """Raw data type definition of this column."""

    order: Union[int, None, UnsetType] = UNSET
    """Order (position) in which this column appears in the table (starting at 1)."""

    nested_column_order: Union[str, None, UnsetType] = UNSET
    """Order (position) in which this column appears in the nested Column (nest level starts at 1)."""

    nested_column_count: Union[int, None, UnsetType] = UNSET
    """Number of columns nested within this (STRUCT or NESTED) column."""

    column_hierarchy: Union[list[dict[str, str]], None, UnsetType] = UNSET
    """List of top-level upstream nested columns."""

    is_partition: Union[bool, None, UnsetType] = UNSET
    """Whether this column is a partition column (true) or not (false)."""

    partition_order: Union[int, None, UnsetType] = UNSET
    """Order (position) of this partition column in the table."""

    is_clustered: Union[bool, None, UnsetType] = UNSET
    """Whether this column is a clustered column (true) or not (false)."""

    is_primary: Union[bool, None, UnsetType] = UNSET
    """When true, this column is the primary key for the table."""

    is_foreign: Union[bool, None, UnsetType] = UNSET
    """When true, this column is a foreign key to another table. NOTE: this must be true when using the foreignKeyTo relationship to specify columns that refer to this column as a foreign key."""

    is_indexed: Union[bool, None, UnsetType] = UNSET
    """When true, this column is indexed in the database."""

    is_sort: Union[bool, None, UnsetType] = UNSET
    """Whether this column is a sort column (true) or not (false)."""

    is_dist: Union[bool, None, UnsetType] = UNSET
    """Whether this column is a distribution column (true) or not (false)."""

    is_pinned: Union[bool, None, UnsetType] = UNSET
    """Whether this column is pinned (true) or not (false)."""

    pinned_by: Union[str, None, UnsetType] = UNSET
    """User who pinned this column."""

    pinned_at: Union[int, None, UnsetType] = UNSET
    """Time (epoch) at which this column was pinned, in milliseconds."""

    precision: Union[int, None, UnsetType] = UNSET
    """Total number of digits allowed, when the dataType is numeric."""

    default_value: Union[str, None, UnsetType] = UNSET
    """Default value for this column."""

    is_nullable: Union[bool, None, UnsetType] = UNSET
    """When true, the values in this column can be null."""

    numeric_scale: Union[float, None, UnsetType] = UNSET
    """Number of digits allowed to the right of the decimal point."""

    max_length: Union[int, None, UnsetType] = UNSET
    """Maximum length of a value in this column."""

    validations: Union[dict[str, str], None, UnsetType] = UNSET
    """Validations for this column."""

    parent_column_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the column this column is nested within, for STRUCT and NESTED columns."""

    parent_column_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the column this column is nested within, for STRUCT and NESTED columns."""

    sql_distinct_values_count: Union[int, None, UnsetType] = UNSET
    """Number of rows that contain distinct values."""

    sql_distinct_values_count_long: Union[int, None, UnsetType] = UNSET
    """Number of rows that contain distinct values."""

    sql_histogram: Union[dict[str, Any], None, UnsetType] = UNSET
    """List of values in a histogram that represents the contents of this column."""

    sql_max: Union[float, None, UnsetType] = UNSET
    """Greatest value in a numeric column."""

    sql_min: Union[float, None, UnsetType] = UNSET
    """Least value in a numeric column."""

    sql_mean: Union[float, None, UnsetType] = UNSET
    """Arithmetic mean of the values in a numeric column."""

    sql_sum: Union[float, None, UnsetType] = UNSET
    """Calculated sum of the values in a numeric column."""

    sql_median: Union[float, None, UnsetType] = UNSET
    """Calculated median of the values in a numeric column."""

    sql_standard_deviation: Union[float, None, UnsetType] = UNSET
    """Calculated standard deviation of the values in a numeric column."""

    sql_unique_values_count: Union[int, None, UnsetType] = UNSET
    """Number of rows in which a value in this column appears only once."""

    sql_unique_values_count_long: Union[int, None, UnsetType] = UNSET
    """Number of rows in which a value in this column appears only once."""

    sql_average: Union[float, None, UnsetType] = UNSET
    """Average value in this column."""

    sql_average_length: Union[float, None, UnsetType] = UNSET
    """Average length of values in a string column."""

    sql_duplicate_values_count: Union[int, None, UnsetType] = UNSET
    """Number of rows that contain duplicate values."""

    sql_duplicate_values_count_long: Union[int, None, UnsetType] = UNSET
    """Number of rows that contain duplicate values."""

    sql_maximum_string_length: Union[int, None, UnsetType] = UNSET
    """Length of the longest value in a string column."""

    column_maxs: Union[list[str], None, UnsetType] = UNSET
    """List of the greatest values in a column."""

    sql_minimum_string_length: Union[int, None, UnsetType] = UNSET
    """Length of the shortest value in a string column."""

    column_mins: Union[list[str], None, UnsetType] = UNSET
    """List of the least values in a column."""

    sql_missing_values_count: Union[int, None, UnsetType] = UNSET
    """Number of rows in a column that do not contain content."""

    sql_missing_values_count_long: Union[int, None, UnsetType] = UNSET
    """Number of rows in a column that do not contain content."""

    sql_missing_values_percentage: Union[float, None, UnsetType] = UNSET
    """Percentage of rows in a column that do not contain content."""

    sql_uniqueness_percentage: Union[float, None, UnsetType] = UNSET
    """Ratio indicating how unique data in this column is: 0 indicates that all values are the same, 100 indicates that all values in this column are unique."""

    sql_variance: Union[float, None, UnsetType] = UNSET
    """Calculated variance of the values in a numeric column."""

    column_top_values: Union[list[dict[str, Any]], None, UnsetType] = UNSET
    """List of top values in this column."""

    sql_max_value: Union[float, None, UnsetType] = UNSET
    """Greatest value in a numeric column."""

    sql_min_value: Union[float, None, UnsetType] = UNSET
    """Least value in a numeric column."""

    sql_mean_value: Union[float, None, UnsetType] = UNSET
    """Arithmetic mean of the values in a numeric column."""

    sql_sum_value: Union[float, None, UnsetType] = UNSET
    """Calculated sum of the values in a numeric column."""

    sql_median_value: Union[float, None, UnsetType] = UNSET
    """Calculated median of the values in a numeric column."""

    sql_standard_deviation_value: Union[float, None, UnsetType] = UNSET
    """Calculated standard deviation of the values in a numeric column."""

    sql_average_value: Union[float, None, UnsetType] = UNSET
    """Average value in this column."""

    sql_variance_value: Union[float, None, UnsetType] = UNSET
    """Calculated variance of the values in a numeric column."""

    sql_average_length_value: Union[float, None, UnsetType] = UNSET
    """Average length of values in a string column."""

    sql_distribution_histogram: Union[dict[str, Any], None, UnsetType] = UNSET
    """Detailed information representing a histogram of values for a column."""

    sql_depth_level: Union[int, None, UnsetType] = UNSET
    """Level of nesting of this column, used for STRUCT and NESTED columns."""

    nosql_collection_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the cosmos/mongo collection in which this SQL asset (column) exists, or empty if it does not exist within a cosmos/mongo collection."""

    nosql_collection_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the cosmos/mongo collection in which this SQL asset (column) exists, or empty if it does not exist within a cosmos/mongo collection."""

    sql_is_measure: Union[bool, None, UnsetType] = UNSET
    """When true, this column is of type measure/calculated."""

    sql_measure_type: Union[str, None, UnsetType] = UNSET
    """The type of measure/calculated column this is, eg: base, calculated, derived."""

    query_count: Union[int, None, UnsetType] = UNSET
    """Number of times this asset has been queried."""

    query_user_count: Union[int, None, UnsetType] = UNSET
    """Number of unique users who have queried this asset."""

    query_user_map: Union[dict[str, int], None, UnsetType] = UNSET
    """Map of unique users who have queried this asset to the number of times they have queried it."""

    query_count_updated_at: Union[int, None, UnsetType] = UNSET
    """Time (epoch) at which the query count was last updated, in milliseconds."""

    database_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the database in which this SQL asset exists, or empty if it does not exist within a database."""

    database_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the database in which this SQL asset exists, or empty if it does not exist within a database."""

    schema_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the schema in which this SQL asset exists, or empty if it does not exist within a schema."""

    schema_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the schema in which this SQL asset exists, or empty if it does not exist within a schema."""

    table_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the table in which this SQL asset exists, or empty if it does not exist within a table."""

    table_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the table in which this SQL asset exists, or empty if it does not exist within a table."""

    view_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the view in which this SQL asset exists, or empty if it does not exist within a view."""

    view_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the view in which this SQL asset exists, or empty if it does not exist within a view."""

    calculation_view_name: Union[str, None, UnsetType] = UNSET
    """Simple name of the calculation view in which this SQL asset exists, or empty if it does not exist within a calculation view."""

    calculation_view_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the calculation view in which this SQL asset exists, or empty if it does not exist within a calculation view."""

    is_profiled: Union[bool, None, UnsetType] = UNSET
    """Whether this asset has been profiled (true) or not (false)."""

    last_profiled_at: Union[int, None, UnsetType] = UNSET
    """Time (epoch) at which this asset was last profiled, in milliseconds."""

    sql_ai_model_context_qualified_name: Union[str, None, UnsetType] = UNSET
    """Unique name of the context in which the model versions exist, or empty if it does not exist within an AI model context."""

    sql_is_secure: Union[bool, None, UnsetType] = UNSET
    """Whether this asset is secure (true) or not (false)."""


class ColumnRelationshipAttributes(AssetRelationshipAttributes):
    """Column-specific relationship attributes for nested API format."""

    table: Union[RelatedTable, None, UnsetType] = UNSET
    """Table in which this column exists."""

    nested_columns: Union[list[RelatedColumn], None, UnsetType] = UNSET
    """Nested columns that exist within this column."""

    parent_column: Union[RelatedColumn, None, UnsetType] = UNSET
    """Column in which this sub-column is nested."""

    table_partition: Union[RelatedTablePartition, None, UnsetType] = UNSET
    """Table partition that contains this column."""

    view: Union[RelatedView, None, UnsetType] = UNSET
    """View in which this column exists."""

    calculation_view: Union[RelatedCalculationView, None, UnsetType] = UNSET
    """Calculate view in which this column exists."""

    materialised_view: Union[RelatedMaterialisedView, None, UnsetType] = UNSET
    """Materialized view in which this column exists."""

    snowflake_dynamic_table: Union[RelatedSnowflakeDynamicTable, None, UnsetType] = (
        UNSET
    )
    """SnowflakeDynamicTable in which this column exists."""

    foreign_key_to: Union[list[RelatedColumn], None, UnsetType] = UNSET
    """Columns that use this column as a foreign key."""

    foreign_key_from: Union[RelatedColumn, None, UnsetType] = UNSET
    """Column this foreign key column refers to."""

    queries: Union[list[RelatedQuery], None, UnsetType] = UNSET
    """Queries that access this column."""


class ColumnNested(AssetNested):
    """Column in nested API format for high-performance serialization."""

    attributes: Union[ColumnAttributes, UnsetType] = UNSET
    relationship_attributes: Union[ColumnRelationshipAttributes, UnsetType] = UNSET
    append_relationship_attributes: Union[ColumnRelationshipAttributes, UnsetType] = (
        UNSET
    )
    remove_relationship_attributes: Union[ColumnRelationshipAttributes, UnsetType] = (
        UNSET
    )


# =============================================================================
# CONVERSION FUNCTIONS
# =============================================================================


def _column_to_nested(column: Column) -> ColumnNested:
    """Convert flat Column to nested format."""
    attrs = ColumnAttributes(
        data_type=column.data_type,
        sub_data_type=column.sub_data_type,
        sql_compression=column.sql_compression,
        sql_encoding=column.sql_encoding,
        raw_data_type_definition=column.raw_data_type_definition,
        order=column.order,
        nested_column_order=column.nested_column_order,
        nested_column_count=column.nested_column_count,
        column_hierarchy=column.column_hierarchy,
        is_partition=column.is_partition,
        partition_order=column.partition_order,
        is_clustered=column.is_clustered,
        is_primary=column.is_primary,
        is_foreign=column.is_foreign,
        is_indexed=column.is_indexed,
        is_sort=column.is_sort,
        is_dist=column.is_dist,
        is_pinned=column.is_pinned,
        pinned_by=column.pinned_by,
        pinned_at=column.pinned_at,
        precision=column.precision,
        default_value=column.default_value,
        is_nullable=column.is_nullable,
        numeric_scale=column.numeric_scale,
        max_length=column.max_length,
        validations=column.validations,
        parent_column_qualified_name=column.parent_column_qualified_name,
        parent_column_name=column.parent_column_name,
        sql_distinct_values_count=column.sql_distinct_values_count,
        sql_distinct_values_count_long=column.sql_distinct_values_count_long,
        sql_histogram=column.sql_histogram,
        sql_max=column.sql_max,
        sql_min=column.sql_min,
        sql_mean=column.sql_mean,
        sql_sum=column.sql_sum,
        sql_median=column.sql_median,
        sql_standard_deviation=column.sql_standard_deviation,
        sql_unique_values_count=column.sql_unique_values_count,
        sql_unique_values_count_long=column.sql_unique_values_count_long,
        sql_average=column.sql_average,
        sql_average_length=column.sql_average_length,
        sql_duplicate_values_count=column.sql_duplicate_values_count,
        sql_duplicate_values_count_long=column.sql_duplicate_values_count_long,
        sql_maximum_string_length=column.sql_maximum_string_length,
        column_maxs=column.column_maxs,
        sql_minimum_string_length=column.sql_minimum_string_length,
        column_mins=column.column_mins,
        sql_missing_values_count=column.sql_missing_values_count,
        sql_missing_values_count_long=column.sql_missing_values_count_long,
        sql_missing_values_percentage=column.sql_missing_values_percentage,
        sql_uniqueness_percentage=column.sql_uniqueness_percentage,
        sql_variance=column.sql_variance,
        column_top_values=column.column_top_values,
        sql_max_value=column.sql_max_value,
        sql_min_value=column.sql_min_value,
        sql_mean_value=column.sql_mean_value,
        sql_sum_value=column.sql_sum_value,
        sql_median_value=column.sql_median_value,
        sql_standard_deviation_value=column.sql_standard_deviation_value,
        sql_average_value=column.sql_average_value,
        sql_variance_value=column.sql_variance_value,
        sql_average_length_value=column.sql_average_length_value,
        sql_distribution_histogram=column.sql_distribution_histogram,
        sql_depth_level=column.sql_depth_level,
        nosql_collection_name=column.nosql_collection_name,
        nosql_collection_qualified_name=column.nosql_collection_qualified_name,
        sql_is_measure=column.sql_is_measure,
        sql_measure_type=column.sql_measure_type,
        query_count=column.query_count,
        query_user_count=column.query_user_count,
        query_user_map=column.query_user_map,
        query_count_updated_at=column.query_count_updated_at,
        database_name=column.database_name,
        database_qualified_name=column.database_qualified_name,
        schema_name=column.schema_name,
        schema_qualified_name=column.schema_qualified_name,
        table_name=column.table_name,
        table_qualified_name=column.table_qualified_name,
        view_name=column.view_name,
        view_qualified_name=column.view_qualified_name,
        calculation_view_name=column.calculation_view_name,
        calculation_view_qualified_name=column.calculation_view_qualified_name,
        is_profiled=column.is_profiled,
        last_profiled_at=column.last_profiled_at,
        sql_ai_model_context_qualified_name=column.sql_ai_model_context_qualified_name,
        sql_is_secure=column.sql_is_secure,
    )
    # Categorize relationships by save semantic (REPLACE, APPEND, REMOVE)
    rel_fields: list[str] = [
        "table",
        "nested_columns",
        "parent_column",
        "table_partition",
        "view",
        "calculation_view",
        "materialised_view",
        "snowflake_dynamic_table",
        "foreign_key_to",
        "foreign_key_from",
        "queries",
    ]
    replace_rels, append_rels, remove_rels = categorize_relationships(
        column, rel_fields, ColumnRelationshipAttributes
    )
    return ColumnNested(
        guid=column.guid,
        type_name=column.type_name,
        status=column.status,
        version=column.version,
        create_time=column.create_time,
        update_time=column.update_time,
        created_by=column.created_by,
        updated_by=column.updated_by,
        classifications=column.classifications,
        classification_names=column.classification_names,
        meanings=column.meanings,
        labels=column.labels,
        business_attributes=column.business_attributes,
        custom_attributes=column.custom_attributes,
        pending_tasks=column.pending_tasks,
        proxy=column.proxy,
        is_incomplete=column.is_incomplete,
        provenance_type=column.provenance_type,
        home_id=column.home_id,
        attributes=attrs,
        relationship_attributes=replace_rels,
        append_relationship_attributes=append_rels,
        remove_relationship_attributes=remove_rels,
    )


def _column_from_nested(nested: ColumnNested) -> Column:
    """Convert nested format to flat Column."""
    attrs = nested.attributes if nested.attributes is not UNSET else ColumnAttributes()
    # Merge relationships from all three buckets
    rel_fields: list[str] = [
        "table",
        "nested_columns",
        "parent_column",
        "table_partition",
        "view",
        "calculation_view",
        "materialised_view",
        "snowflake_dynamic_table",
        "foreign_key_to",
        "foreign_key_from",
        "queries",
    ]
    merged_rels = merge_relationships(
        nested.relationship_attributes,
        nested.append_relationship_attributes,
        nested.remove_relationship_attributes,
        rel_fields,
        ColumnRelationshipAttributes,
    )
    return Column(
        guid=nested.guid,
        type_name=nested.type_name,
        status=nested.status,
        version=nested.version,
        create_time=nested.create_time,
        update_time=nested.update_time,
        created_by=nested.created_by,
        updated_by=nested.updated_by,
        classifications=nested.classifications,
        classification_names=nested.classification_names,
        meanings=nested.meanings,
        labels=nested.labels,
        business_attributes=nested.business_attributes,
        custom_attributes=nested.custom_attributes,
        pending_tasks=nested.pending_tasks,
        proxy=nested.proxy,
        is_incomplete=nested.is_incomplete,
        provenance_type=nested.provenance_type,
        home_id=nested.home_id,
        data_type=attrs.data_type,
        sub_data_type=attrs.sub_data_type,
        sql_compression=attrs.sql_compression,
        sql_encoding=attrs.sql_encoding,
        raw_data_type_definition=attrs.raw_data_type_definition,
        order=attrs.order,
        nested_column_order=attrs.nested_column_order,
        nested_column_count=attrs.nested_column_count,
        column_hierarchy=attrs.column_hierarchy,
        is_partition=attrs.is_partition,
        partition_order=attrs.partition_order,
        is_clustered=attrs.is_clustered,
        is_primary=attrs.is_primary,
        is_foreign=attrs.is_foreign,
        is_indexed=attrs.is_indexed,
        is_sort=attrs.is_sort,
        is_dist=attrs.is_dist,
        is_pinned=attrs.is_pinned,
        pinned_by=attrs.pinned_by,
        pinned_at=attrs.pinned_at,
        precision=attrs.precision,
        default_value=attrs.default_value,
        is_nullable=attrs.is_nullable,
        numeric_scale=attrs.numeric_scale,
        max_length=attrs.max_length,
        validations=attrs.validations,
        parent_column_qualified_name=attrs.parent_column_qualified_name,
        parent_column_name=attrs.parent_column_name,
        sql_distinct_values_count=attrs.sql_distinct_values_count,
        sql_distinct_values_count_long=attrs.sql_distinct_values_count_long,
        sql_histogram=attrs.sql_histogram,
        sql_max=attrs.sql_max,
        sql_min=attrs.sql_min,
        sql_mean=attrs.sql_mean,
        sql_sum=attrs.sql_sum,
        sql_median=attrs.sql_median,
        sql_standard_deviation=attrs.sql_standard_deviation,
        sql_unique_values_count=attrs.sql_unique_values_count,
        sql_unique_values_count_long=attrs.sql_unique_values_count_long,
        sql_average=attrs.sql_average,
        sql_average_length=attrs.sql_average_length,
        sql_duplicate_values_count=attrs.sql_duplicate_values_count,
        sql_duplicate_values_count_long=attrs.sql_duplicate_values_count_long,
        sql_maximum_string_length=attrs.sql_maximum_string_length,
        column_maxs=attrs.column_maxs,
        sql_minimum_string_length=attrs.sql_minimum_string_length,
        column_mins=attrs.column_mins,
        sql_missing_values_count=attrs.sql_missing_values_count,
        sql_missing_values_count_long=attrs.sql_missing_values_count_long,
        sql_missing_values_percentage=attrs.sql_missing_values_percentage,
        sql_uniqueness_percentage=attrs.sql_uniqueness_percentage,
        sql_variance=attrs.sql_variance,
        column_top_values=attrs.column_top_values,
        sql_max_value=attrs.sql_max_value,
        sql_min_value=attrs.sql_min_value,
        sql_mean_value=attrs.sql_mean_value,
        sql_sum_value=attrs.sql_sum_value,
        sql_median_value=attrs.sql_median_value,
        sql_standard_deviation_value=attrs.sql_standard_deviation_value,
        sql_average_value=attrs.sql_average_value,
        sql_variance_value=attrs.sql_variance_value,
        sql_average_length_value=attrs.sql_average_length_value,
        sql_distribution_histogram=attrs.sql_distribution_histogram,
        sql_depth_level=attrs.sql_depth_level,
        nosql_collection_name=attrs.nosql_collection_name,
        nosql_collection_qualified_name=attrs.nosql_collection_qualified_name,
        sql_is_measure=attrs.sql_is_measure,
        sql_measure_type=attrs.sql_measure_type,
        query_count=attrs.query_count,
        query_user_count=attrs.query_user_count,
        query_user_map=attrs.query_user_map,
        query_count_updated_at=attrs.query_count_updated_at,
        database_name=attrs.database_name,
        database_qualified_name=attrs.database_qualified_name,
        schema_name=attrs.schema_name,
        schema_qualified_name=attrs.schema_qualified_name,
        table_name=attrs.table_name,
        table_qualified_name=attrs.table_qualified_name,
        view_name=attrs.view_name,
        view_qualified_name=attrs.view_qualified_name,
        calculation_view_name=attrs.calculation_view_name,
        calculation_view_qualified_name=attrs.calculation_view_qualified_name,
        is_profiled=attrs.is_profiled,
        last_profiled_at=attrs.last_profiled_at,
        sql_ai_model_context_qualified_name=attrs.sql_ai_model_context_qualified_name,
        sql_is_secure=attrs.sql_is_secure,
        # Merged relationship attributes
        **merged_rels,
    )


def _column_to_nested_bytes(column: Column, serde: Serde) -> bytes:
    """Convert flat Column to nested JSON bytes."""
    return serde.encode(_column_to_nested(column))


def _column_from_nested_bytes(data: bytes, serde: Serde) -> Column:
    """Convert nested JSON bytes to flat Column."""
    nested = serde.decode(data, ColumnNested)
    return _column_from_nested(nested)
